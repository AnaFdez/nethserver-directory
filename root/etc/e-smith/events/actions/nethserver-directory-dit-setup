#!/usr/bin/perl
#
# Copyright (C) 2012 Nethesis S.r.l.
# http://www.nethesis.it - support@nethesis.it
# 
# This script is part of NethServer.
# 
# NethServer is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License,
# or any later version.
# 
# NethServer is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with NethServer.  If not, see <http://www.gnu.org/licenses/>.
#
use NethServer::Directory;
use NethServer::Directory::LDAP;
use esmith::ConfigDB;

my $ldap = NethServer::Directory->new;
my $configDb = esmith::ConfigDB->open_ro();
my %OrganizationContact = $configDb->get('OrganizationContact')->props or {'Company' => 'Not Set'};
my $internalSuffix = NethServer::Directory::getInternalSuffix();

my @entries = (
    [ $internalSuffix,
      attrs => [
	  objectClass => ['top', 'dcObject', 'organization'],
	  dc => 'directory',
	  o => $OrganizationContact{Company},
      ] ],    
    [ 'ou=People,' . $internalSuffix,
      attrs => [
	  objectClass => ['top', 'organizationalUnit'],
	  ou => 'People',
      ] ],
    [ 'ou=Groups,' . $internalSuffix,
      attrs => [
	  objectClass => ['top', 'organizationalUnit'],
	  ou => 'Groups',
      ] ],

    #
    # authentication services accounts (replace with SASL whenever possible):
    #

    [ 'cn=libuser,' . $internalSuffix,
      attrs => [
	  objectClass => ['device', 'simpleSecurityObject'],
	  cn => 'libuser',
	  userPassword => NethServer::Directory::getUserPassword('libuser', 1),
	  description => "libuser account management"
      ] ],
    [ 'cn=pam,' . $internalSuffix,
      attrs => [
	  objectClass => ['device', 'simpleSecurityObject'],
	  cn => 'pam',
	  userPassword => NethServer::Directory::getUserPassword('pam', 1),
	  description => "pam_ldap module - root password service operations"
      ] ],
    );

my $exitCode = 0;

foreach(@entries) {
    my $message = $ldap->merge(@{$_});
    if($message->is_error) {
	warn 'Error modifying `' . @{$_}[0] . '`: ' . join(" ", $message->code, $message->error_name());
	$exitCode ++;
    }
}

exit($exitCode);
